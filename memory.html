<!DOCTYPE html>
<html>
<head>
  <title>Memory</title>
  <link rel="stylesheet" type="text/css" href="stylesheet.css">
  <link rel="stylesheet prefetch" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
  <link rel="stylesheet prefetch" href="https://fonts.googleapis.com/css?family=Coda">
</head>
<body>
  <div class = "page">
    <header class="header">
        <h1>Match!</h1>
        <section class="score-panel">
            <span id="stars">Your Star Rating:</span>
            <ul class="stars starlist">
              <li><i class="fa fa-star"></i></li>
              <li><i class="fa fa-star"></i></li>
              <li><i class="fa fa-star"></i></li>
            </ul>

            <div class="move-counter">
              <span class="moves">0</span>
            <span>Moves</span>
          </div>

          <div class="timer"></div>

              <div class="restart">
              <button>  <i class="fa fa-repeat"></i></button>
            </div>
          </section>
    </header>
  </div>

  <script>

//First, let's put in all parts needed to initialize the deck
const deck = document.createElement("div");
const page = document.querySelector(".page");
const icons = ["fa-bomb","fa-bomb", "fa-trophy", "fa-trophy", "fa-phone",
"fa-phone", "fa-camera-retro", "fa-camera-retro", "fa-cloud", "fa-cloud",
"fa-truck", "fa-truck", "fa-beer", "fa-beer", "fa-spinner", "fa-spinner"];
let timeRunning;

//Create the board space.
deck.classList.add("board");
//Add the board to the page.
page.appendChild(deck);

//Loop over the array to create the cards.
const createCards = function() {
  for (const icon of icons) {
    const newCard = document.createElement("div");
    newCard.classList.add("card", icon, "fa", "closed", "inGame");
    deck.appendChild(newCard);
  }
};
//Shuffle the deck.
const shuffle = function() {
  for (let i = deck.children.length; i >= 0; i--) {
    deck.appendChild(deck.children[Math.random() * i | 0]);
   }
 };

createCards();
shuffle();

//Now, let's put in the components needed to run the game once, from beginning
//to end.
//We need functions for starting the timer, counting the moves, showing and
//hiding the cards, checking for matches and adding them to the match list, and
//for decreasing stars. Finally, we need functionality for ending the game,
//either because the player won or because they lost.
let moves = 0;
const mover = document.querySelector(".moves");
const cards = document.querySelectorAll('.card');
let picked = [];
let matches = 0;
const openCards = document.getElementsByClassName("open");
let timer = document.querySelector('.timer');
let seconds = 0;
let gameInProgress = false;

function startTimer() {
  seconds+=1;
  timer.innerText = formatTime(seconds);
};

function formatTime(x) {
  let minuteHand =  "0" + (Math.floor(x/60)).toString()
  let secondHand = "0" + (x % 60).toString();
  minuteHand = minuteHand.slice(-2);
  secondHand = secondHand.slice(-2);
  return minuteHand + ":" + secondHand;
}
function openCard(x) {
//open a closed card and add to picked array
  if (x.target.classList.contains("closed")) {
    x.target.classList.remove("closed");
    x.target.classList.add("open");
    picked.push(x.target.classList.value);
  } else {
//close an open card and remove from picked array
    x.target.classList.add("closed");
    openCardIndex = picked.indexOf(x.target.classList.value);
    picked.splice(openCardIndex, 1);
    x.target.classList.remove("open");
  }
  }


//check if 2 cards match.
  function areTwoOpen() {
    if (picked.length === 2) {
      return true;
    } else {
      return false;
    }};


  function doCardsMatch() {
    if (picked[0] === picked[1]) {
      return true;
    } else {
      return false;
    }
  }

  //if cards match, change their class to card match
  function onMatch() {
    const openCards = document.querySelectorAll(".open");
    for (card of openCards) {
      card.classList = "match card";
      matches++;
  }}


//if cards do not match, remove the class "open" and add class "closed" to both
  function notMatch() {
    setTimeout(function waitFirst() {
      const openCards = document.querySelectorAll(".open");
      for (card of openCards) {
      card.classList.add("closed");
      card.classList.remove("open");
      //picked = [];
    }},300);
  }

//at the end of a move, increment the move counter and empty the picked array
  function endMove() {
    moves+=1;
    mover.innerText = moves.toString();
    picked = [];
    starRemove();
  };

  //every 5 moves, remove a star
  function starRemove(){
    if (moves === 15 || moves === 20 || moves === 25) {
      const starToRemove = document.querySelector('li');
      starToRemove.parentNode.removeChild(starToRemove);
    }
  }

  //pop up the "You Win!" box
  function youWin() {
    const winBox = document.createElement("div");
    winBox.classList.add("win");
    winBox.textContent = "You win!!";
    deck.appendChild(winBox);
  }

//pop up the "You Lose." box
function youLose() {
    const loseBox = document.createElement("div");
    loseBox.classList.add("win");
    loseBox.textContent = "You lose.";
    deck.appendChild(loseBox);
}

function removeWin() {
  const winBox = document.querySelector(".win");
  if (winBox !== null) {
    winBox.parentNode.removeChild(winBox);
  }
}

function gameOver() {
    if (matches === 16) {
      youWin();
    } else {
      youLose();
    }
    matches = 0;
  }

function runGame() {
//put an event listener on each card
deck.addEventListener('click', function(e) {
  if (e.target.classList.contains('card', 'inGame')) {
    //start the timer if it's not running yet
    if(gameInProgress===false){
      gameInProgress = true;
      timeRunning = setInterval(startTimer,1000);

    }
    //open or close the card that was clicked
    openCard(e);
    //then you check if 2 cards are open. If only 1 is open, do nothing.
    if (areTwoOpen() === true) {
      //if 2 cards are open, check if they match.
      if (doCardsMatch() === true) {
        onMatch();
      } else {
        notMatch();
      }
      endMove();
      if(matches === 16 || moves === 28) {
        gameOver();
        clearInterval(timeRunning);
      }
    };

  };
  });
};

runGame();
function closeAllCards() {
  for (card of cards) {
    card.classList.remove('match');
    card.classList.add('closed', 'fa');
  }
}

function refresh() {
  picked = [];
  mover.innerText = "0";
  moves = 0;
  clearInterval(timeRunning);
  timer.innerText = "00:00"
  closeAllCards();
  removeWin();
  shuffle();
}
/*


//add event listener to button to restart on click
const refresh = document.querySelector('.restart');
refresh.addEventListener('click', restartGame);
//to reset game, remove all stars, remove all class match, add
//all class closed, remove class win, set moves to 0, empty picked
//array, reset matches to 0, and change move counter to 0. Also run the game functionality again.
//Let's split this into more than
//one function: reset stars, reset cards, and reset moves.
function restartGame(){
  resetStars();
  resetCards();
  resetMoves();
  removeGameOver();
  runGame();
  matches = 0;
}

function resetStars(){
  //remove existing stars
  const allStars = document.querySelectorAll('li');
  for (star of allStars) {
    star.parentNode.removeChild(star);
  };
  //add 3 new stars
  function addStar() {
    const newStar = document.createElement('li');
    newStar.classList.add('fa');
    newStar.classList.add('fa-star');
    const yourStarRating = document.querySelector('.starlist');
    yourStarRating.appendChild(newStar);
  }
  addStar();
  addStar();
  addStar();
}

function resetCards() {
  const allCards = document.querySelectorAll('.card');
  for (card of allCards) {
    card.parentNode.removeChild(card);
  }
  createCards();
}

function resetMoves() {
  mover.innerText = 0;
  moves = 0;
}

function removeGameOver() {
  const gameOverBox = document.querySelector(".win");
  if (gameOverBox !== null) {
    gameOverBox.parentNode.removeChild(gameOverBox);
  }
}

//Timer functionality
How does the timer work?
0- seconds starts at 0 seconds.
1- when user clicks the first card seconds begins to increment every second. innerText of onscreen timer changes to value of seconds/60 etc.
2 - when matches = 16, step 1 stops.
3 - when user presses refresh, start again at step 0.
function restartTime() {
  seconds = 0;
}
let timer = document.querySelector('.timer');


function incrementSeconds() {
  seconds +=1;
  timer.innerText = Math.floor(seconds/60)+":"+seconds%60;
}
*/


//function twoDigitFormat(x) {
//  return ("0"+ x.toString()).slice(-2);
//};

//

//function formattedTime() {

//  timer.innerText = twoDigitFormat(elapsedMinutes) + ":" + twoDigitFormat(elapsedSeconds);
//};
//
</script>
</body>
</html>

<!--TODO: - stop timer when game is won.
- reset timer on refresh.-->
